name: Build Release
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: 🧾 Checkout código
        uses: actions/checkout@v4

      - name: ⚙️ Configurar .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: ⚙️ Configurar Visual Studio
        uses: microsoft/setup-msbuild@v1.3

      - name: 📦 Instalar NuGet CLI
        run: choco install nuget.commandline -y

      - name: 🔧 Configurar FodyWeavers.xml
        shell: pwsh
        run: |
          Write-Host "🔧 Criando FodyWeavers.xml..."
        
          $xml = '<?xml version="1.0" encoding="utf-8"?>'
          $xml += '<Weavers xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="FodyWeavers.xsd">'
          $xml += '  <Costura />'
          $xml += '</Weavers>'
        
          $xml | Out-File -FilePath "FodyWeavers.xml" -Encoding UTF8 -Force
          Write-Host "✅ FodyWeavers.xml configurado!"

      - name: 🗑️ Limpar bin/obj
        shell: pwsh
        run: |
          @("bin", "obj") | ForEach-Object {
            if (Test-Path $_) { Remove-Item -Recurse -Force $_ -ErrorAction SilentlyContinue }
          }

      - name: 🔄 Restaurar dependências solução
        shell: pwsh
        run: |
          nuget restore Spotify.sln -Verbosity detailed
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: 🔨 Compilar Release
        shell: pwsh
        run: |
          msbuild Spotify.sln /p:Configuration=Release /p:Platform="Any CPU" /t:Rebuild /verbosity:minimal /p:UseSharedCompilation=false
          if ($LASTEXITCODE -ne 0) { exit 1 }
          if (!(Test-Path "bin\Release\Spotify.exe")) { Write-Host "❌ Executável não gerado"; exit 1 }
          Write-Host "✅ Build concluído com sucesso!"
          $size = (Get-Item "bin\Release\Spotify.exe").Length
          Write-Host "📊 Tamanho: $([math]::Round($size/1MB,2)) MB"

      - name: 📁 Upload Artefato
        uses: actions/upload-artifact@v4
        with:
          name: Spotify-Release
          path: bin/Release/Spotify.exe
          retention-days: 90
